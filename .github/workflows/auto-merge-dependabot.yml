
# MaintAInPro Auto-Merge Dependabot PRs
# Purpose: Automatically approve and merge eligible Dependabot PRs for security/patch/minor updates.
# Triggers: Only runs for code changes, not docs-only edits.
name: ğŸ¤– Auto-Merge Dependabot PRs
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**/*.ts'
      - '**/*.js'
      - 'client/**'
      - 'server/**'
      - 'shared/**'
      - 'api/**'
    paths-ignore:
      - 'Documentation/**'
      - '**/*.md'
      - 'CHANGELOG.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge-dependabot:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Check PR details
        id: pr-check
        run: |
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "PR labels: ${{ join(github.event.pull_request.labels.*.name) }}"

          # Check if this is a security update or patch/minor update
          if [[ "${{ github.event.pull_request.title }}" == *"security"* ]] || \
             [[ "${{ github.event.pull_request.title }}" == *"patch"* ]] || \
             [[ "${{ github.event.pull_request.title }}" == *"minor"* ]]; then
            echo "auto-merge=true" >> $GITHUB_OUTPUT
            echo "âœ… This PR is eligible for auto-merge"
          else
            echo "auto-merge=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ This PR requires manual review (major version or other changes)"
          fi

      - name: âœ… Auto-approve PR
        if: steps.pr-check.outputs.auto-merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'ğŸ¤– Auto-approved by CI/CD pipeline for Dependabot security/patch/minor update'
            });

      - name: ğŸ”— Enable auto-merge
        if: steps.pr-check.outputs.auto-merge == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: ğŸ·ï¸ Add auto-merge label
        if: steps.pr-check.outputs.auto-merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['automerge', 'ğŸ¤– dependabot']
            });

      - name: ğŸ’¬ Comment on manual review PRs
        if: steps.pr-check.outputs.auto-merge == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ‘€ Manual Review Required

            This Dependabot PR contains major version updates or other changes that require manual review.

            **Next Steps:**
            1. ğŸ“ Review the changelog and breaking changes
            2. ğŸ§ª Test the changes locally if needed
            3. âœ… Approve the PR if changes look good
            4. ğŸ·ï¸ Add the \`automerge\` label to enable auto-merge

            **Files changed:** ${context.payload.pull_request.changed_files}
            **Additions:** +${context.payload.pull_request.additions}
            **Deletions:** -${context.payload.pull_request.deletions}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
